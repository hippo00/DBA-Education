Date:2019-12-20

## Overview

The Event Manager is the BAW component that is responsible for the movement of tokens through a Process, scheduling and execution of system lane tasks, UCAs and timers. Each BAW node will have its own Event Manager and will pick up its next available tasks to execute. The Event Manager has two types of queues in which it holds tasks: Async and sync queues. UCAs, timers and BPD notifications run from the async queue and you can configure up to 3 sync queues if you want sequential firing of certain tasks. The Event Manager has many configurable options to increase the speed or throttle the retrieval and executions of these tasks. 

![图片 1](https://media.github.ibm.com/user/228551/files/7dbf9800-22fd-11ea-86ed-a8b74c69fdbd)

Event Manager Page:
Event Manager tasks will show up in the Event Manager -> Monitor page in the Process Admin Console. A user can also pause/resume Event Managers via the console or REST APIs. The Monitor page also shows a connection expiration data which is updated via a heartbeat every 30 seconds. This also lets other Event Managers in other nodes coordinated.

## Components

1.https://www.ibm.com/support/knowledgecenter/en/SS8JB4/com.ibm.wbpm.admin.doc/topics/maintaining_event_manager.html
2.https://www.ibm.com/developerworks/community/blogs/aimsupport/entry/ibm_bpm_event_manager_common_problems?lang=en
3.https://support.bp-3.com/hc/en-us/articles/202911143-Event-Manager-in-IBM-BPM-Standard-the-missing-manual

## Troubleshooting

#### Data Collection

<p>1.In order to get an understanding of the data being generated by the Event Manager, you can configure Event Manager to log all of the task history of the event manager:</p>

```
<task-execution-listener merge="mergeChildren">com.lombardisoftware.server.scheduler.DbTaskExecutionListener</task-execution-listener>
```
https://support.bp-3.com/hc/en-us/articles/205022337-IBM-BPM-Event-Manager-history-data-table-LSW-EM-TASK-HISTORY
Note: This data is not automatically purged so it is up to the customer to manually remove these entries. Enabling this functionality should not cause any performance issues.

2.If you would like a lightweight trace, just to understand what is happening in the event manager, you can use the lightweight trace string option:

`*=info:WLE.wle_scheduler=ALL:WLE.wle_sched_basic:ALL`

https://www.ibm.com/support/knowledgecenter/en/SS8JB4/com.ibm.wbpm.admin.doc/topics/troubleshooting_bpdsandflows.html
The information gathered with this may not be adequate as you may need to find out what the BPD Engine and the Service Engine is running during this time.

<p>3.To get a full picture of the Event Manager and engines (Process and Service), it may be best to gather the full analysis of the WLE package trace as well as database tracing. You might be able to avoid database tracing if the customer has may concerns on performance:</p>

`*=info:WLE.*=all:org.springframework.jdbc.*=all:WAS.clientinfopluslogging=all`

#### Data Analysis

Example Description:
The following is a quick test of what a Support Engineer might see while the Event Manager schedules and executes its tasks. In this scenario, I created a simple Process (Process A) Which contains a UCA attached to an intermediate event. The UCA is scheduled, executes, and starts another process (Process B).

Disclaimer: This example solely highlights the Event Manager component and how it works. The classes and methods in **Bold** show what you most likely see in a trace. This example does not cover all available configurations for the Event Manager. The Event Manager is a highly efficient scheduler, and in most cases, poor application design or tuning is the root cause. It is best to review the reference “Common Problems with the Event Manager” as most defects with this part of the product have been resolved.

1.This is the thread that kicks off the UCA. In this thread, we can see the Intermediate Event being executed, and the UCA is scheduled. You should see the two entries in the LSW_EM_TASK table and the LSW_EM_TASK_KEYWORDS table:
```
[12/12/19 10:42:02:818 PST] 00000306 EventWorker   > com.lombardisoftware.bpd.component.flowcomponent.event.worker.EventWorker doWork ENTRY flowObject = Intermediate Event
[12/12/19 10:42:02:843 PST] 00000306 UCASchedulerH > com.lombardisoftware.server.eventmgr.UCASchedulerHelper scheduleMessageUCA ENTRY message = <reason type="UCAIDMessage" filteredProjectShortName="FS" …

[12/12/19 10:42:02:925 PST] 00000306 wle_sched_bas > com.lombardisoftware.server.scheduler.TaskManager scheduleTasks ENTRY emTasks=[com.lombardisoftware.server.scheduler.ScheduledTask@76e84231
...
[12/12/19 10:42:02:930 PST] 00000306 clientinfoplu >  prepareStatement Entry
                                 com.ibm.ws.rsadapter.jdbc.WSJccSQLJPDQConnection@4ff7e71
                                 insert into lsw_em_task_keywords (task_id, keyword) values (?, ?)
[12/12/19 10:42:02:936 PST] 00000306 clientinfoplu >  prepareStatement Entry
                                 com.ibm.ws.rsadapter.jdbc.WSJccSQLJPDQConnection@4ff7e71
                                 insert into lsw_em_task (
                                       task_id, description, queue_id, scheduled_time,
                                       task_status, blackout_calendar_id, blackout_behavior,
                                       task_execution_class, task_arguments_str, task_arguments, in_closing_transaction,
                                       repeat_string, re_execute_count, task_owner
                                   ) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
```
The end result is task 99:
```
[12/12/19 10:42:02:945 PST] 00000306 TaskManager   1 com.lombardisoftware.server.scheduler.TaskManager scheduleTaskChunk  Scheduling task 
Task_Id = 99 
com.lombardisoftware.server.scheduler.ScheduledTask@76e84231
- scheduledTime: 1576176122927 = Thu Dec 12 10:42:02 PST 2019
- repeatString: null
- execClassName: com.lombardisoftware.server.scheduler.tasks.UcaExecutorTask
- arguments: 4.02308530-3c0f-4cd5-befb-11420787eb10;5;myUCA<reason type="UCAIDMessage" filteredProjectShortName="FS" filteredSnapshotName="Snap2" filteredProjectID="2066.c9da34eb-ee99-4bb5-9fc4-0934c77a670f" filteredSnapshotID="2064.4ce0a14f-239d-46ee-bc36-9a191008fafb" ucaId="4.02308530-3c0f-4cd5-befb-11420787eb10">
  <shortName>FS</shortName>
  <param name="correlationKey">
    <value>&lt;variable type="String"&gt;&lt;![CDATA[default BPD EVENT Correlation Key]]&gt;&lt;/variable&gt;</value>
  </param>
  <param name="value">
    <value>&lt;variable type="String"&gt;&lt;![CDATA[default BPD EVENT Value]]&gt;&lt;/variable&gt;</value>
  </param>
</reason>
- description: Run the 'myUCA' UCA, triggered by message event or Invoke UCA step
- queueId: -100
- blackoutCalendarId: 1
- blackoutBehavior: BlackoutBehavior(3, EXECUTE_MANY_AFTER_BLACKOUT)
- inClosingTransaction: false
- idInDB: 99
- reuseStrategy: 0
- keywords: List start
   - uca4.02308530-3c0f-4cd5-befb-11420787eb10
   - invokeUCA
    List end
```
2.This is the Event Manager task loader thread that is continuously running, picking up any new available tasks to schedule out. Remember, this is a UCA tasks and these are acquired from the async queue, unless a customer manually created a sync queue. In this scenario, this thread found task 99 above and updates the task_status in the LSW_EM_TASK to “2”, which means “Scheduled” and then to “3” (“Executing”) once it is ready to execute the task. As of now, these are the tasks statuses and what they mean in the database:
 
SCHEDULED("Scheduled"):
The task has been scheduled, but has not yet been acquired by an Event Manager (or, it was acquired and released by its owner, or its owner's heartbeat stopped.). The task status code in the database is 1.
     
ACQUIRED("Acquired"):
The task has been acquired by a living Event Manager. The task status code in the database is 2.
     
EXECUTING("Executing"):
The task has been acquired by a living Event Manager, and has begun execution. The task status code in the database is 3.
     
BLACKED_OUT("Blacked out"):
The task would have been executed, except it was in a blackout period. Depending on its configured blackout behavior, this task may be revisited at the end of the blackout period. The task status code in the database is 4.
```
[12/12/19 10:42:03:158 PST] 0000017f TaskLoader    > com.lombardisoftware.server.scheduler.TaskLoader loadTasks ENTRY Queue: Queue -100: Async Queue (capacity 10) maxTasks: 10
[12/12/19 10:42:03:161 PST] 0000017f TaskLoader    < com.lombardisoftware.server.scheduler.TaskLoader executeLoaderFindTasksInExistingTx RETURN Found tasks with the following IDs: [99]

…

[12/12/19 10:42:03:162 PST] 0000017f TaskLoader    > com.lombardisoftware.server.scheduler.TaskLoader acquireTasksAfterLoadForDb2Luw ENTRY
[12/12/19 10:42:03:163 PST] 0000017f clientinfoplu >  prepareStatement Entry
                                 com.ibm.ws.rsadapter.jdbc.WSJccSQLJPDQConnection@9874bbc7
                                 UPDATE LSW_EM_TASK
            SET TASK_STATUS = 2, TASK_OWNER = ?
            WHERE TASK_OWNER IS NULL AND TASK_ID = ?

....

[12/12/19 10:42:03:171 PST] 0000017f TaskLoader    3 com.lombardisoftware.server.scheduler.TaskLoader acquireTasksAfterLoadForDb2Luw task 99 acquired

…

[12/12/19 10:42:03:173 PST] 0000017d Engine        > com.lombardisoftware.server.scheduler.Engine executeTasks ENTRY [com.lombardisoftware.server.scheduler.SimpleTask@e6372348
- taskId: 99
- scheduledTime: 1576176122928 = Thu Dec 12 10:42:02 PST 2019
- executeTime: 1576176123161 = Thu Dec 12 10:42:03 PST 2019
- discriminator: 1047
- executing: true]
[12/12/19 10:42:03:173 PST] 0000017d Engine        3 com.lombardisoftware.server.scheduler.Engine loadTasksIfOwnerInternal  executing for instance=2 and taskId in [ 99 ]
UPDATE LSW_EM_TASK SET TASK_STATUS = 3 WHERE TASK_ID = ? AND TASK_OWNER = ? AND TASK_STATUS != 3
 ```
 
3.Finally, this thread shows how the event manager executes task ID 99, finds the UCA and the associated process (ProcessB) and starts the instance (InstanceID 132):
```
[12/12/19 10:42:03:208 PST] 00000223 wle_sched_bas > com.lombardisoftware.server.scheduler.Engine execute ENTRY emTaskId=99, scheduledTime=Thu Dec 12 10:42:02 PST 2019, execClassName=com.lombardisoftware.server.scheduler.tasks.UcaExecutorTask
[12/12/19 10:42:03:208 PST] 00000223 wle_sched_bas 3 com.lombardisoftware.server.scheduler.Engine execute keywords=[invokeUCA, uca4.02308530-3c0f-4cd5-befb-11420787eb10]
[12/12/19 10:42:03:210 PST] 00000223 EventMgrCore  > com.lombardisoftware.server.ejb.eventmgr.EventMgrCore executeUCA ENTRY id = UCA.02308530-3c0f-4cd5-befb-11420787eb10, xmlReason = <reason type="UCAIDMessage" filteredProjectShortName="FS" filteredSnapshotName="Snap2" filteredProjectID="2066.c9da34eb-ee99-4bb5-9fc4-0934c77a670f" filteredSnapshotID="2064.4ce0a14f-239d-46ee-bc36-9a191008fafb" ucaId="4.02308530-3c0f-4cd5-befb-11420787eb10">
 ...
[12/12/19 10:42:03:264 PST] 00000223 UnderCoverAge 1 com.lombardisoftware.server.eventmgr.UnderCoverAgentExecutor doGet Found Under Cover Agent: myUCA, resolvedUcaRef: [Snapshot.4ce0a14f-239d-46ee-bc36-9a191008fafb,UCA.02308530-3c0f-4cd5-befb-11420787eb10], VersioningContext in resolvedUcaRef: 2064.4ce0a14f-239d-46ee-bc36-9a191008fafb (snapshotName: Snap2, branchName: Main, projectName: My Sandbox), VersioningContext in UCA PO: 2064.4ce0a14f-239d-46ee-bc36-9a191008fafb (snapshotName: Snap2, branchName: Main, projectName: My Sandbox)
....
[12/12/19 10:42:03:511 PST] 00000223 BPDExecutionC > com.lombardisoftware.bpd.runtime.engine.BPDExecutionContext BPDExecutionContext ENTRY instanceId = BpmnInstanceId(132), diagramId = Ref[/BPD.5a6f57bf-ae89-432f-a4f8-ed432794449d], startObjectId=BPDObjectIdImpl(0ae997bf-6f54-49f2-80f3-42d1475a0264), startLaneOwnerId = 9, caseId = null, activityId = null, replyHandler = null
```
Related database tables with regards to the Event Manager to know:
&nbsp;&nbsp;&nbsp;&nbsp;LSW_EM_INSTANCE
&nbsp;&nbsp;&nbsp;&nbsp;LSW_EM_TASK
&nbsp;&nbsp;&nbsp;&nbsp;LSW_EM_TASK_KEYWORDS
&nbsp;&nbsp;&nbsp;&nbsp;LSW_EM_BLACKOUT
&nbsp;&nbsp;&nbsp;&nbsp;LSW_EM_HISTORY
&nbsp;&nbsp;&nbsp;&nbsp;LSW_EM_SYNC_QUEUE
Additional data can be found here:
https://pages.github.ibm.com/hippo00/BAW-Database-Documentation/

**Tuning to Solve Problems:**
When customers run into performance problems, usually the Event Manager backs up with tasks and is not able to quickly execute tasks as fast as a customer would like. This may involve tuning the Event Manager to speed up its executions. Increase the queue capacity too much and the customer may run into memory problems. It is best to gauge the capacity based off the number of CPUs (cores) as described in our performance Redbook:

Recommendation: To optimize throughput and scaling, start with a bpd-queue-capacity of 10 per physical processor core (for example, 40 for a 4-processor core configuration), with a maximum value of 80. This is not an absolute limit, but consider the potential impact on Process Server memory utilization if the value is increased beyond 80.

IBM Business Process Manager V8.5 Performance Tuning and Best Practices
http://www.redbooks.ibm.com/redbooks/pdfs/sg248216.pdf

**When tuning is not enough:**
There may be times, when tuning is not sufficient for a customer. Infinite loop or poor design may increase the tasks in the LSW_EM_TASK to the millions. This may need additional assistance. First, if an infinite loop is the root cause, pause the event manager. If the Process Admin Console is not reachable due to large amount of tasks, stop the server, and pause the event manager via a server configuration change and start BAW back up. Steps are noted here:

A looping or run away business process definition (BPD) or service might occur in IBM Business Process Manager (BPM)
https://www-01.ibm.com/support/docview.wss?uid=swg21622584

Second, check whether the buildup of tasks are BPD notification tasks, timers, or system lane activities. These are associated with an instance and deleting the instance should delete these tasks from the Event Manager. This is the safest and easiest option. 

Unfortunately, UCAs are not associated with instances so removing instances will not remove these types of tasks from the queue. If they fail upon their execution, you will see a scheduled date of 2099/02/01 (YYYY/MM/DD) and you can safely remove these via the wsadmin command, REST API, or Process Admin Console. As of now, there is no way of removing scheduled tasks from the Event Manager. In this case, you may need the assistance of Development to determine the best route to remove these tasks. Usually, Development may provide certain steps and queries, such as the following:

1.Back up the lsw_em_task and lsw_em_task_keywords tables.
2.Run following queries to cleanup for their situation:
&nbsp;&nbsp;&nbsp;&nbsp;2.1)
&nbsp;&nbsp;&nbsp;&nbsp;delete from LSW_EM_TASK_KEYWORDS where task_id in (select task_id from lsw_em_task where description like '%Execute <UCA_NAME>, triggered by invokeUCA%');
&nbsp;&nbsp;&nbsp;&nbsp;2.2)
&nbsp;&nbsp;&nbsp;&nbsp;delete from LSW_EM_TASK_KEYWORDS where task_id in (select task_id from lsw_em_task where description like '%Execute <UCA_NAME>, triggered by invokeUCA%');
&nbsp;&nbsp;&nbsp;&nbsp;2.3)
&nbsp;&nbsp;&nbsp;&nbsp;delete from lsw_em_task where description like '%Execute <UCA_NAME>, triggered by invokeUCA%';
&nbsp;&nbsp;&nbsp;&nbsp;2.4)
&nbsp;&nbsp;&nbsp;&nbsp;delete from lsw_em_task where description like '%Execute <UCA_NAME>, triggered by invokeUCA%';

